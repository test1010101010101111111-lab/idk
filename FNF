-- Funky Friday
-- Vortex

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local gamename = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name

local player = game:GetService("Players").LocalPlayer

local Window = Fluent:CreateWindow({
    Title = "Vortex Elite  |",
    SubTitle = gamename,
    TabWidth = 130,
    Size = UDim2.fromOffset(490, 400),
    Acrylic = true,
    Theme = "Amethyst",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Updates = Window:AddTab({ Title = "Home", Icon = "home" }),
    Main = Window:AddTab({ Title = "Main", Icon = "play" }),
}

local Toggle = Tabs.Main:AddToggle("Toggle", {
    Title = "Auto Player",
    Description = "Automatically Hit Notes (toggle while in song)",
    Default = false
})

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- State (NO _G)
local State = {
    enabled = false,
    delay = 0,
    side = nil,
    keymap = {},
    columns = {},
    connection = nil
}

-- Detect side
local function detectSide()
    local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    for _, stage in ipairs(workspace.Map.Stages:GetChildren()) do
        local teams = stage:FindFirstChild("Teams")
        if teams then
            for _, side in {"Left", "Right"} do
                local pad = teams:FindFirstChild(side)
                if pad and (root.Position - pad.Position).Magnitude <= 5 then
                    State.side = side
                    return
                end
            end
        end
    end
end

-- Cache lanes
local function cacheColumns()
    local field = player.PlayerGui.Window.Game.Fields[State.side]
    if not field then return end

    local inner = field.Inner
    State.columns = {}

    for i = 1, 9 do
        local lane = inner:FindFirstChild("Lane" .. i)
        if lane then
            State.columns[i] = lane.Notes
        end
    end
end

-- Cache keybinds
llocal function cacheKeybinds()
    local inner = player.PlayerGui.Window.Game.Fields[State.side].Inner
    State.keymap = {}

    for i = 1, 9 do
        local lane = inner:FindFirstChild("Lane"..i)
        if lane and lane:FindFirstChild("Labels") then
            local labelObj = lane.Labels:FindFirstChild("Label")
            if labelObj and labelObj:FindFirstChild("Text") then
                local keyName = labelObj.Text
                local key = Enum.KeyCode[keyName]
                if key then
                    State.keymap[i] = key
                end
            end
        end
    end
end


-- Play notes
local function autoplayStep()
    local threshold = 0.4 + State.delay

    for col, notes in pairs(State.columns) do
        for _, note in ipairs(notes:GetChildren()) do
            if note:IsA("GuiObject") and note.Position.Y.Scale > threshold then
                VirtualInputManager:SendKeyEvent(true, State.keymap[col], false, game)

                if #note:GetChildren() == 2 then
                    task.spawn(function()
                        while note.Parent and note.Position.Y.Scale > threshold and State.enabled do
                            RunService.Heartbeat:Wait()
                        end
                        VirtualInputManager:SendKeyEvent(false, State.keymap[col], false, game)
                    end)
                else
                    VirtualInputManager:SendKeyEvent(false, State.keymap[col], false, game)
                end
            end
        end
    end
end

local function enable()
    if State.enabled then return end

    detectSide()

    if not State.side then
        Fluent:Notify({
            Title = "Auto Player",
            Content = "Stand on a stage pad before enabling.",
            Duration = 3
        })
        return
    end

    cacheColumns()
    cacheKeybinds()

    State.enabled = true
    State.connection = RunService.Heartbeat:Connect(autoplayStep)
end


-- Disable
local function disable()
    State.enabled = false
    if State.connection then
        State.connection:Disconnect()
        State.connection = nil
    end
end

Toggle:OnChanged(function(Value)
    if Value then
        enable()
    else
        disable()
    end
end)

Toggle:SetValue(false)


game.GuiService.MenuOpened:Connect(function()
    if Toggle.Value then
        _G.Toggled = true
        Toggle:SetValue(false)
    end
end)

game.GuiService.MenuClosed:Connect(function()
    if not Toggle.Value and _G.Toggled then
        _G.Toggled = false
        Toggle:SetValue(true)
    end
end)

local Keybind = Tabs.Main:AddKeybind("Keybind", {
    Title = "Auto Player Keybind",
    Mode = "Toggle",
    Default = "Insert",

    Callback = function(Value)
        if Toggle.Value then
            Toggle:SetValue(false)
        else
            Toggle:SetValue(true)
        end
    end,
})

local Section = Tabs.Main:AddParagraph({
    Title = "Use DownScroll",
})

Tabs.Main:AddSection("Adjustments")

local Slider = Tabs.Main:AddSlider("Slider", {
    Title = "Note ms Delay",
    Description = "More = Later",
    Default = 0,
    Min = -0.4,
    Max = 0.4,
    Rounding = 2,
    Callback = function(Value)
        State.delay = Value

        local downscroll = false
        pcall(function()
            downscroll =
                player.PlayerGui.GameGui.Windows.Configuration
                .Frame.Body.Content.Settings.Entries
                .ScrollingFrame.DownScroll.Toggle.Inner.BackgroundColor3
                == Color3.new(85/255, 255/255, 85/255)
        end)

        if downscroll then
            State.delay = -State.delay
        end
    end
})

loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

Window:SelectTab(1)

local Timer = Tabs.Updates:AddParagraph({
    Title = "Time: 00:00:00",
})

local st = os.time()

local function timer()
    while true do
        local et = os.difftime(os.time(), st)
        local h = math.floor(et / 3600)
        local m = math.floor((et % 3600) / 60)
        local s = et % 60
        local ft = string.format("Time: %02d:%02d:%02d", h, m, s)

        Timer:SetTitle(ft)
        task.wait(1)
    end
end

coroutine.wrap(timer)()

Tabs.Updates:AddButton({
    Title = "Discord Server",
    Description = "Copies Discord Invite Link",
    Callback = function()
        setclipboard("https://discord.gg/44PHnFKxq5")
        Fluent:Notify({Title = "Uni Hub", Content = "Copied Successfuly", Duration = 2})
    end
})

Tabs.Updates:AddButton({
    Title = "Run Infinite Yield",
    Callback = function()
        loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source'))()
    end
})

local backpack = player:WaitForChild("Backpack")
if backpack:FindFirstChild("Ui") then
    backpack:FindFirstChild("Ui"):Destroy()
end

local tool = Instance.new("Tool")
tool.Name = "Ui"
tool.RequiresHandle = false
tool.TextureId = "rbxassetid://135519282079256"
tool.Parent = backpack

Open = true
tool.Activated:Connect(function()
    if Open then
        Window:Minimize()
    else
        Window:Minimize()
    end
end)

local VirtualUser = game:GetService('VirtualUser')
game:GetService('Players').LocalPlayer.Idled:connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)
