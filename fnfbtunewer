-- Funky Friday
-- Vortex Elite Auto Player

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local gamename = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name
local player = game:GetService("Players").LocalPlayer

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "Vortex Elite  |",
    SubTitle = gamename,
    TabWidth = 130,
    Size = UDim2.fromOffset(490, 400),
    Acrylic = true,
    Theme = "Amethyst",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Updates = Window:AddTab({ Title = "Home", Icon = "home" }),
    Main = Window:AddTab({ Title = "Main", Icon = "play" }),
}

local Side = nil
local keymap = {}
_G.Mode = "Static"
_G.Delay = 0
_G.auto = false

-- Update keymap based on lane labels
local function updateKeys()
    if not Side then return end
    local fields = player.PlayerGui.Window.Game.Fields[Side].Inner
    for i = 1, 9 do
        local lane = fields["Lane"..i]
        if lane and lane.Labels and lane.Labels.Label then
            keymap[i] = Enum.KeyCode[lane.Labels.Label.Text]
        end
    end
end

-- Determine which side the player is on
local function CheckSide()
    pcall(function()
        local character = player.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")
        if not rootPart then return end

        local minDistToLeft = math.huge
        local minDistToRight = math.huge

        for _, stage in pairs(workspace.Map.Stages:GetChildren()) do
            if stage:FindFirstChild("Teams") then
                local pads = stage.Teams
                local left = pads:FindFirstChild("Left")
                local right = pads:FindFirstChild("Right")

                if left and (rootPart.Position - left.Position).magnitude <= 5 then
                    minDistToLeft = math.min(minDistToLeft, (rootPart.Position - left.Position).magnitude)
                end

                if right and (rootPart.Position - right.Position).magnitude <= 5 then
                    minDistToRight = math.min(minDistToRight, (rootPart.Position - right.Position).magnitude)
                end
            end
        end

        if minDistToLeft < minDistToRight then
            Side = "Left"
        elseif minDistToRight < minDistToLeft then
            Side = "Right"
        else
            Side = nil
        end

        updateKeys()
    end)
end

-- Get columns for autoplay
local function setupColumns(side)
    local columns = {}
    pcall(function()
        local ap = player.PlayerGui.Window.Game.Fields[side].Inner
        for i = 1, 9 do
            local lane = ap["Lane"..i]
            if lane then
                columns[i] = lane.Notes
            end
        end
    end)
    return columns
end

-- Autoplay logic
local function autoplay()
    local RunService = game:GetService("RunService")
    local VirtualInputManager = game:GetService("VirtualInputManager")
    local pressedKeys = {}

    while _G.auto do
        if Side then
            local columns = setupColumns(Side)
            local threshold = 0.4 + (_G.Delay or 0)

            for colNum, col in pairs(columns) do
                for _, note in ipairs(col:GetChildren()) do
                    if note:IsA("GuiObject") then
                        local active = note.Position.Y.Scale > threshold
                        if active and not pressedKeys[note] then
                            VirtualInputManager:SendKeyEvent(true, keymap[colNum], false, game)
                            pressedKeys[note] = true

                            -- Long notes
                            if #note:GetChildren() == 2 then
                                coroutine.wrap(function()
                                    while note.Parent and note.Position.Y.Scale > threshold and _G.auto do
                                        RunService.Heartbeat:Wait()
                                    end
                                    VirtualInputManager:SendKeyEvent(false, keymap[colNum], false, game)
                                    pressedKeys[note] = nil
                                end)()
                            end
                        elseif not active and pressedKeys[note] then
                            VirtualInputManager:SendKeyEvent(false, keymap[colNum], false, game)
                            pressedKeys[note] = nil
                        end
                    end
                end
            end
        end
        RunService.Heartbeat:Wait()
    end
end

-- Toggle Auto Player
local Toggle = Tabs.Main:AddToggle("Toggle", {
    Title = "Auto Player",
    Description = "Automatically Hit Notes (toggle while in song)",
    Default = false
})

Toggle:OnChanged(function()
    _G.auto = Toggle.Value
    if _G.auto then
        updateKeys()
        coroutine.wrap(autoplay)()
    end
end)

-- Keybind toggle
Tabs.Main:AddKeybind("Keybind", {
    Title = "Auto Player Keybind",
    Mode = "Toggle",
    Default = "Insert",
    Callback = function()
        Toggle:SetValue(not Toggle.Value)
    end,
})

-- Delay slider & mode
Tabs.Main:AddDropdown("Dropdown", {
    Title = "Delay Mode",
    Values = {"Static", "Random"},
    Multi = false,
    Default = 1,
    Callback = function(Value) _G.Mode = Value end,
})

Tabs.Main:AddSlider("Slider", {
    Title = "Note ms Delay",
    Description = "More = Later",
    Default = 0,
    Min = -0.4,
    Max = 0.4,
    Rounding = 2,
    Callback = function(Value)
        if _G.Mode == "Static" then
            _G.Delay = Value
        else
            task.spawn(function()
                while true do
                    _G.Delay = math.random() * Value
                    task.wait()
                end
            end)
        end
    end,
})

-- Timer
local Timer = Tabs.Updates:AddParagraph({ Title = "Time: 00:00:00" })
local startTime = os.time()
coroutine.wrap(function()
    while true do
        local t = os.difftime(os.time(), startTime)
        local h = math.floor(t / 3600)
        local m = math.floor((t % 3600) / 60)
        local s = t % 60
        Timer:SetTitle(string.format("Time: %02d:%02d:%02d", h, m, s))
        task.wait(1)
    end
end)()

-- Auto side check while in song selector
game:GetService("RunService").RenderStepped:Connect(function()
    local gui = player.PlayerGui.GameGui
    if gui.Windows.SongSelector.Visible then
        CheckSide()
    end
end)

-- Idle prevent
local vu = game:GetService("VirtualUser")
player.Idled:Connect(function()
    vu:CaptureController()
    vu:ClickButton2(Vector2.new())
end)

-- Setup UI Tool
local backpack = player:WaitForChild("Backpack")
if backpack:FindFirstChild("Ui") then backpack.Ui:Destroy() end
local tool = Instance.new("Tool")
tool.Name = "Ui"
tool.RequiresHandle = false
tool.TextureId = "rbxassetid://135519282079256"
tool.Parent = backpack
tool.Activated:Connect(function() Window:Minimize() end)

-- Load interface manager addon
loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()
Window:SelectTab(1)
