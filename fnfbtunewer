-- Funky Friday
-- 1xyzz

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local gamename = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name

local player = game:GetService("Players").LocalPlayer

local Window = Fluent:CreateWindow({
    Title = "Vortex |",
    SubTitle = gamename,
    TabWidth = 130,
    Size = UDim2.fromOffset(490, 400),
    Acrylic = true,
    Theme = "Amethyst",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Updates = Window:AddTab({ Title = "Home", Icon = "home" }),
    Main = Window:AddTab({ Title = "Main", Icon = "play" }),
}

local Side = nil

local Toggle = Tabs.Main:AddToggle("Toggle", {
    Title = "Auto Player",
    Description = "Automatically Hit Notes (toggle while in song)",
    Default = false
})

-- Improved autoplay functions
local function getKeymap()
    if not Side then return {} end
    local fields = player.PlayerGui.Window.Game.Fields[Side].Inner
    local map = {}
    for i = 1, 9 do
        local lane = fields["Lane"..i]
        if lane and lane:FindFirstChild("Labels") and lane.Labels:FindFirstChild("Label") then
            local keyText = lane.Labels.Label.Text
            map[i] = Enum.KeyCode[keyText] -- converts string like "A" to Enum.KeyCode.A
        end
    end
    return map
end

local function setupColumns()
    if not Side then return {} end
    local fields = player.PlayerGui.Window.Game.Fields[Side].Inner
    local columns = {}
    for i = 1, 9 do
        local lane = fields["Lane"..i]
        if lane and lane:FindFirstChild("Notes") then
            columns[i] = lane.Notes:GetChildren()
        else
            columns[i] = {}
        end
    end
    return columns
end

local function autoplay()
    local RunService = game:GetService("RunService")
    local VirtualInputManager = game:GetService("VirtualInputManager")
    local pressedKeys = {}

    while _G.auto do
        if Side then
            local keymap = getKeymap()
            local columns = setupColumns()
            local threshold = 0.4 + (_G.Delay or 0)

            for colNum, notes in pairs(columns) do
                for _, note in ipairs(notes) do
                    if note:IsA("GuiObject") then
                        -- Press key
                        if note.Position.Y.Scale > threshold and not pressedKeys[note] then
                            pressedKeys[note] = true
                            VirtualInputManager:SendKeyEvent(true, keymap[colNum], false, game)

                            -- Handle long notes
                            if #note:GetChildren() == 2 then
                                coroutine.wrap(function()
                                    while note.Parent and note.Position.Y.Scale > threshold and _G.auto do
                                        RunService.Heartbeat:Wait()
                                    end
                                    VirtualInputManager:SendKeyEvent(false, keymap[colNum], false, game)
                                    pressedKeys[note] = nil
                                end)()
                            end
                        -- Release key
                        elseif note.Position.Y.Scale <= threshold and pressedKeys[note] then
                            VirtualInputManager:SendKeyEvent(false, keymap[colNum], false, game)
                            pressedKeys[note] = nil
                        end
                    end
                end
            end
        end
        RunService.Heartbeat:Wait()
    end
end

-- Toggle callback
Toggle:OnChanged(function()
    if Toggle.Value then
        _G.auto = true
        coroutine.wrap(autoplay)()
    else
        _G.auto = false
    end
end)

Toggle:SetValue(false)

-- Menu handling
game.GuiService.MenuOpened:Connect(function()
    if Toggle.Value then
        _G.Toggled = true
        Toggle:SetValue(false)
    end
end)

game.GuiService.MenuClosed:Connect(function()
    if not Toggle.Value and _G.Toggled then
        _G.Toggled = false
        Toggle:SetValue(true)
    end
end)

-- Keybind
local Keybind = Tabs.Main:AddKeybind("Keybind", {
    Title = "Auto Player Keybind",
    Mode = "Toggle",
    Default = "Insert",
    Callback = function()
        Toggle:SetValue(not Toggle.Value)
    end,
})

-- Rest of your GUI code (sliders, dropdowns, timer, buttons, etc.) remains unchanged
-- ...

-- Function to check which side player is on
function CheckSide()
    pcall(function()
        local character = player.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")

        local minDistToLeft = math.huge
        local minDistToRight = math.huge

        for _, stage in pairs(workspace.Map.Stages:GetChildren()) do
            local teams = stage:FindFirstChild("Teams")
            if teams then
                local leftPad = teams:FindFirstChild("Left")
                local rightPad = teams:FindFirstChild("Right")

                if leftPad then
                    local dist = (rootPart.Position - leftPad.Position).Magnitude
                    if dist < minDistToLeft then minDistToLeft = dist end
                end
                if rightPad then
                    local dist = (rootPart.Position - rightPad.Position).Magnitude
                    if dist < minDistToRight then minDistToRight = dist end
                end
            end
        end

        if minDistToLeft < minDistToRight then
            Side = "Left"
        else
            Side = "Right"
        end
    end)
end

-- Optional: periodically update side
task.spawn(function()
    while true do
        CheckSide()
        task.wait(0.5)
    end
end)
